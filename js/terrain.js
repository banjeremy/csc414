var Terrain = {};
Terrain.generateHeight = function( width, height ){

    var size = width * height, data = new Float32Array( size ),
    perlin = new ImprovedNoise(), quality = 1, z = Math.random() * 100;

    for ( var i = 0; i < size; i ++ ) {

        data[ i ] = 0

    }

    for ( var j = 0; j < 4; j ++ ) {

        for ( var i = 0; i < size; i ++ ) {
//		if(i%width==0||i%(height-1)){
  //              data[i]+=10;
    //    	}
      // 	 	else if (i<width|| i>width*(height-1)){
//                        data[i]+=10;
 //               }
//		else{
            var x = i % width, y = ~~ ( i / width );
            data[ i ] += Math.abs( perlin.noise( x / quality, y / quality, z ) * quality * 1.75 );
//		}
	}
        quality *= 5;

    }
                
data.min = data[0];
    for (var i = 0; i < size; i++) {
        if (data[i] < data.min) {
            data.min = data[i];
        }
    }
for ( var i = 0; i < size; i ++ ) {
              if(i%width==0){// ||i%(height-1)==0){
                data[i]=data.min;
              }
                      else if (i<width|| i>width*(height-1)){
                       data[i]=data.min;
                }
		else if(i%width==1 || i%width==15){
			data[i]=data.min;
		}
//		else{
//		data[i]*=.5;
//		}
}

data.max = data[0];
    for (var i = 0; i < size; i++) {
        if (data[i] > data.max) {
            data.max = data[i];
        }
    }

    return data;
}

Terrain.generateTexture = function( data, width, height ) {

    var canvas, canvasScaled, context, image, imageData,
    level, diff, vector3, sun, shade;

    vector3 = new THREE.Vector3( 0, 0, 0 );

    sun = new THREE.Vector3( 1, 1, 1 );
    sun.normalize();

    canvas = document.createElement( 'canvas' );
    canvas.width = width;
    canvas.height = height;

    context = canvas.getContext( '2d' );
    context.fillStyle = '#000';
    context.fillRect( 0, 0, width, height );

    image = context.getImageData( 0, 0, canvas.width, canvas.height );
    imageData = image.data;

    for ( var i = 0, j = 0, l = imageData.length; i < l; i += 4, j ++ ) {

        vector3.x = data[ j - 2 ] - data[ j + 2 ];
        vector3.y = 2;
        vector3.z = data[ j - width * 2 ] - data[ j + width * 2 ];
        vector3.normalize();

        shade = vector3.dot( sun );

        imageData[ i ] = ( 96 + shade * 128 ) * ( 0.5 + data[ j ] * 0.007 );
        imageData[ i + 1 ] = ( 32 + shade * 96 ) * ( 0.5 + data[ j ] * 0.007 );
        imageData[ i + 2 ] = ( shade * 96 ) * ( 0.5 + data[ j ] * 0.007 );
    }

    context.putImageData( image, 0, 0 );

    // Scaled 4x

    canvasScaled = document.createElement( 'canvas' );
    canvasScaled.width = width * 4;
    canvasScaled.height = height * 4;

    context = canvasScaled.getContext( '2d' );
    context.scale( 4, 4 );
    context.drawImage( canvas, 0, 0 );

    image = context.getImageData( 0, 0, canvasScaled.width, canvasScaled.height );
    imageData = image.data;

    for ( var i = 0, l = imageData.length; i < l; i += 4 ) {

        var v = ~~ ( Math.random() * 5 );

        imageData[ i ] += v;
        imageData[ i + 1 ] += v;
        imageData[ i + 2 ] += v;

    }

    context.putImageData( image, 0, 0 );

    return canvasScaled;

}

Terrain.getHeight = function(x, z) {
    var pos = new THREE.Vector3();
    var ray = new THREE.Ray();
    ray.origin.x = x;
    ray.origin.y = 1000;
    ray.origin.z = z;
    ray.direction = new THREE.Vector3(0, -1, 0);

    var c = THREE.Collisions.rayCastNearest(ray);
    if (c) {
       pos = ray.origin.clone().subSelf(new THREE.Vector3(0, c.distance, 0));
    }
    else {
        //no Collision -- can we assume camera has left the terrain?

    }          
    return pos.y;
}

Terrain.d =JSON.parse('{"0":74.03082275390625,"1":72.3128433227539,"2":70.81825256347656,"3":70.59864044189453,"4":69.54891967773438,"5":68.51761627197266,"6":66.9549789428711,"7":66.14743041992188,"8":65.47791290283203,"9":65.25025939941406,"10":64.69300079345703,"11":64.22940826416016,"12":64.50589752197266,"13":64.11746978759766,"14":65.64168548583984,"15":66.27086639404297,"16":74.9807357788086,"17":73.06220245361328,"18":72.78395080566406,"19":72.54865264892578,"20":72.40995788574219,"21":70.84724426269531,"22":69.730712890625,"23":67.92705535888672,"24":65.94747161865234,"25":67.26777648925781,"26":67.17637634277344,"27":67.63970184326172,"28":66.91291809082031,"29":66.61637115478516,"30":66.63800811767578,"31":67.05401611328125,"32":74.6449203491211,"33":72.79496765136719,"34":73.78740692138672,"35":73.83699798583984,"36":73.78643035888672,"37":72.94273376464844,"38":70.94071960449219,"39":68.82791137695312,"40":67.60617065429688,"41":69.02454376220703,"42":70.38823699951172,"43":70.3963623046875,"44":70.01087188720703,"45":67.54367065429688,"46":68.74323272705078,"47":68.35599517822266,"48":75.5701904296875,"49":73.69990539550781,"50":72.75702667236328,"51":73.85846710205078,"52":73.50233459472656,"53":72.15218353271484,"54":70.89850616455078,"55":68.48832702636719,"56":68.49300384521484,"57":70.46736145019531,"58":71.70291900634766,"59":72.1015396118164,"60":71.63365936279297,"61":69.6941909790039,"62":69.77252197265625,"63":69.93563842773438,"64":76.37957763671875,"65":75.00135040283203,"66":72.13565826416016,"67":73.31754302978516,"68":72.35505676269531,"69":70.4855728149414,"70":69.0479965209961,"71":68.81881713867188,"72":68.98802185058594,"73":70.40184020996094,"74":71.35987091064453,"75":72.88024139404297,"76":72.64745330810547,"77":71.25305938720703,"78":71.54525756835938,"79":71.90364074707031,"80":76.4107666015625,"81":73.97648620605469,"82":71.9947509765625,"83":72.72815704345703,"84":71.90541076660156,"85":69.89471435546875,"86":69.41619873046875,"87":69.35546112060547,"88":70.15843200683594,"89":70.02425384521484,"90":71.78596496582031,"91":73.13545989990234,"92":73.19374084472656,"93":72.19120025634766,"94":72.97076416015625,"95":74.12493133544922,"96":76.1954345703125,"97":74.24615478515625,"98":71.39221954345703,"99":71.24708557128906,"100":71.171142578125,"101":69.80851745605469,"102":69.30499267578125,"103":69.49434661865234,"104":70.44159698486328,"105":70.77528381347656,"106":72.30867767333984,"107":73.30413818359375,"108":73.49546813964844,"109":72.94225311279297,"110":75.15049743652344,"111":75.8455810546875,"112":76.3261489868164,"113":74.6595687866211,"114":71.93889617919922,"115":69.90742492675781,"116":69.55457305908203,"117":69.59199523925781,"118":68.77311706542969,"119":69.3877944946289,"120":70.42993927001953,"121":72.06454467773438,"122":73.48213958740234,"123":74.9537353515625,"124":75.71272277832031,"125":74.69434356689453,"126":75.52057647705078,"127":76.69767761230469,"128":77.24688720703125,"129":74.9984359741211,"130":72.84346008300781,"131":69.97142028808594,"132":68.60274505615234,"133":68.42321014404297,"134":69.18685913085938,"135":68.9525375366211,"136":70.44159698486328,"137":73.00981140136719,"138":75.32064056396484,"139":77.14949035644531,"140":77.88860321044922,"141":77.32947540283203,"142":76.38127136230469,"143":76.0813217163086,"144":75.55974578857422,"145":74.70512390136719,"146":71.9378890991211,"147":69.33293151855469,"148":67.55435180664062,"149":67.82908630371094,"150":67.92150115966797,"151":68.20746612548828,"152":70.04911804199219,"153":73.37525177001953,"154":75.71566009521484,"155":77.6166763305664,"156":78.8807373046875,"157":78.72319793701172,"158":77.63728332519531,"159":78.28197479248047,"160":72.02605438232422,"161":71.79999542236328,"162":69.70611572265625,"163":68.5668716430664,"164":66.72245025634766,"165":65.96167755126953,"166":66.15951538085938,"167":66.68419647216797,"168":69.21590423583984,"169":72.1676254272461,"170":73.98796081542969,"171":76.18769073486328,"172":77.8000717163086,"173":78.3893814086914,"174":78.0113754272461,"175":77.49398040771484,"176":68.81123352050781,"177":68.05086517333984,"178":67.68075561523438,"179":67.07847595214844,"180":66.33824920654297,"181":65.54457092285156,"182":65.80209350585938,"183":66.5630111694336,"184":68.02674102783203,"185":69.48664855957031,"186":72.16240692138672,"187":74.9492416381836,"188":76.09223175048828,"189":76.9584732055664,"190":76.77812194824219,"191":76.8258285522461,"192":67.9585952758789,"193":66.70469665527344,"194":65.80731964111328,"195":64.63077545166016,"196":64.3868408203125,"197":64.26034545898438,"198":64.54009246826172,"199":64.1348648071289,"200":66.06576538085938,"201":67.36508178710938,"202":69.00717163085938,"203":71.5716323852539,"204":74.73587799072266,"205":75.93653106689453,"206":75.81327056884766,"207":76.67832946777344,"208":71.52452850341797,"209":69.8335952758789,"210":67.96637725830078,"211":64.92125701904297,"212":62.24151611328125,"213":61.5748176574707,"214":61.96320724487305,"215":63.7828483581543,"216":66.1913070678711,"217":68.29119110107422,"218":69.62468719482422,"219":69.6938705444336,"220":72.947265625,"221":75.04598999023438,"222":75.85414123535156,"223":76.11264038085938,"224":73.55706787109375,"225":72.15577697753906,"226":69.28916931152344,"227":66.6803970336914,"228":67.02754211425781,"229":64.98076629638672,"230":62.99622344970703,"231":64.12942504882812,"232":66.22907257080078,"233":68.10693359375,"234":69.00726318359375,"235":69.04967498779297,"236":71.51847839355469,"237":74.64653778076172,"238":76.26480102539062,"239":76.11468505859375,"240":75.10121154785156,"241":73.6953125,"242":69.76798248291016,"243":69.5960922241211,"244":70.49664306640625,"245":68.46006774902344,"246":65.59248352050781,"247":64.02915954589844,"248":64.7040023803711,"249":66.55638122558594,"250":66.6613998413086,"251":66.9581069946289,"252":70.56352233886719,"253":73.58573913574219,"254":75.73310852050781,"255":75.57318115234375,"byteLength":1024,"length":256,"buffer":{"byteLength":1024},"byteOffset":0,"min":61.5748176574707,"max":78.8807373046875}');
